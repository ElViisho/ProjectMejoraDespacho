{% extends 'AppMejoraDespacho/base.html' %}
{% load static %}
{% load form_template_extras %}
{% load i18n %}
{% load tabla_tags %}

{% block header %}
<link rel="stylesheet" href="{% static 'css/apprest.css' %}">
<link rel="stylesheet" href="{% static 'css/tabla.css' %}">
<script src="{% static 'js/js_choices.js' %}"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock header%}

{% block content %}


<form id="filtrado" action="" mehtod="POST">
    {% csrf_token %}
    <div class="block-form_filtrado">        
        <label class="text-filtro">NVV: </label>
        <select id="filtro_NVV" name="filtro_NVV">
            <option value=''>---------------</option>
            {% for item in queryset %}
                <option value="{{ item.nvv }}">{{ item.nvv }}</option>
            {% endfor %}
        </select>
        
        <label class="text-filtro">Región: </label>
        <select id="filtro_region" name="filtro_region">
            <option value=0>---------------</option>
            {% for item in regiones %}
                <option value="{{ item.0 }}">{{ item.1 }}</option>
            {% endfor %}
        </select>
        
        <label class="text-filtro">Comuna: </label>
        <select disabled id="filtro_comuna" name="filtro_comuna">
            <option value=0>---------------</option>
        </select>

        <div class="boton_filtro">
            <input type="submit" id="boton_filtro" value="Filtrar">
        </div>
    </div>
    
</form>


<div class="table-responsive table-l">
    <table class="table table-hover table-striped table-image" id="listado">
        <thead>
            <tr class="text-center">
                <th scope="col">NVV</th>
                <th scope="col">Fecha NVV</th>
                <th scope="col">Fecha solicitud</th>
                <th scope="col">RUT cliente</th>
                <th scope="col">Nombre cliente</th>
                <th scope="col">Región</th>
                <th scope="col">Comuna</th>
                <th scope="col">Dirección</th>
                <th scope="col">Nombre contacto</th>
                <th scope="col">Teléfono contacto</th>
                <th scope="col">Condición de pago</th>
                <th scope="col">Observaciones</th>
                <th scope="col">Estado</th>
                <th scope="col">Comprobante de pago</th>
                <th scope="col">Fecha despacho</th>
                <th scope="col">Hora despacho</th>
                <th scope="col">Fecha entrega</th>
                <th scope="col">Observaciones despacho</th>
                <th scope="col">Documento de salida</th>
                <th scope="col">Número</th>
            </tr>
        </thead>
        <tbody>
            {% for item in datos %}
            <tr class="text-center" id="{{ item.nvv }}">
                {% language 'es' %}
                <td>{{ item.nvv }}</td>
                <td>{{ item.fecha_nvv|date:"d F Y" }}</td>
                <td>{{ item.fecha_solicitud|date:"d F Y H:i" }}</td>
                <td>{{ item.rut }}</td>
                <td>{{ item.cliente }}</td>
                <td>{{ regiones|get_region:item.region }}</td>
                <td>{{ comunas|get_comunas_por_region:item.region|get_comuna:item.comuna }}</td>
                <td>{{ item.direccion }}</td>
                <td>{{ item.nombre_contacto }}</td>
                <td>{{ item.telefono_contacto }}</td>
                <td>{{ item.condicion_pago }}</td>
                <td>{{ item.observacion }}</td>
                <td>
                    {% if item.estado == 2 %}
                        <select class='Estado' id='{{ item.nvv }}'>
                            <option value=0>En preparación</option>
                            <option value=1>Preparado</option>
                            <option selected value=2>Despachado</option>
                        </select>
                    {% elif item.estado == 1 %}
                        <select class='Estado' id='{{ item.nvv }}'>
                            <option value=0>En preparación</option>
                            <option selected value=1>Preparado</option>
                            <option value=2>Despachado</option>
                        </select>
                    {% else %}
                        <select class='Estado' id='{{ item.nvv }}'>
                            <option selected value=0>En preparación</option>
                            <option value=1>Preparado</option>
                            <option value=2>Despachado</option>
                        </select>
                    {% endif %}
                </td>
                <td>
                    {% if item.comprobante_pago == "None" %}
                        No hay
                    {% else %}
                        <a href="{{ item.comprobante_pago.url }}" target="_blank">link</a>
                    {% endif %}
                </td>
                <td>{{ item.fecha_despacho|date:"d F Y" }}</td>
                <td>
                    {% if item.hora_despacho_extra_inicio|date:"G" == "0" %}
                        {{ item.hora_de_despacho_inicio }} - {{ item.hora_de_despacho_fin }}
                    {% else %}
                        {{ item.hora_de_despacho_inicio }} - {{ item.hora_de_despacho_fin }}, {{ item.hora_despacho_extra_inicio }} - {{ item.hora_despacho_extra_fin }}
                    {% endif %}
                </td>
                <td>
                    {% if item.fecha_entregado == None %}
                        No entregado
                    {% else %}
                        {{ item.fecha_entregado|date:"d F Y" }}
                    {% endif %}
                </td>
                <td>{{ item.observacion_despacho }}</td>
                <td>
                    {% if item.documento_salida == "None" %}
                        No hay
                    {% else %}
                        <a href="{{ item.documento_salida.url }}" target="_blank">link</a>
                    {% endif %}
                </td>
                {% endlanguage %}
                <td>{{ item.numero }}</td>
            </tr>
            {% endfor %}
            </tbody>
    </table>
</div>

<div class="pagination">
    <span class="step-links">
        {% if datos.has_previous %}
            <a href="?{% url_replace page=datos.previous_page_number %}">Prev</a>
        {% endif %}
        <span class="current">
            Page {{ datos.number }} of {{ datos.paginator.num_pages }}
        </span>
        {% if datos.has_next %}
            <a href="?{% url_replace page=datos.next_page_number %}">Next</a>
        {% endif %}
    </span>
</div>

<script src="{% static 'js/js_tabla.js' %}"></script>

{% endblock content %}